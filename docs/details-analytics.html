<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Детали — PRICER.demo</title>
  <link rel="stylesheet" href="css/details.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>

  <header>
    <button class="back-btn" onclick="window.location='datacheck.html'">←</button>
    <h1>Аналитика сценариев</h1>

    <div class="menu-container">
      <button class="menu-btn">☰ Сценарий</button>
      <div class="menu-dropdown">
        <button data-scenario="positive">Позитивный</button>
        <button data-scenario="negative">Негативный</button>
      </div>
    </div>
  </header>

  <main>
    <section class="graph-section">
      <div class="graph-placeholder">
        <div id="chartSkeleton" class="skeleton skeleton-block"></div>
        <canvas id="chart" style="display:none;"></canvas>
      </div>

      <div class="settings">
        <h3>Настройки</h3>

        <p>Период анализа:</p>

        <ul class="period-list">
          <li data-period="30">30 дней</li>
          <li data-period="90">90 дней</li>
          <li data-period="180">6 месяцев</li>
          <li data-period="365">1 год</li>
        </ul>

        <hr>
      </div>
    </section>

    <section class="info-section">
      <div class="info-block">
        <h3>Информация</h3>
        <p id="info-text">Выберите сценарий и период для анализа данных.</p>
      </div>

      <div class="info-block">
        <h3>Рекомендации</h3>
        <p id="recommendations-text">После выбора сценария появятся рекомендации.</p>
      </div>
    </section>
  </main>

  <script src="js/chartplaceholder.js?v=6"></script>
  <script>
    // Функция для генерации реалистичных данных цен
    function generatePriceData(days, basePrice = 100) {
      const data = [];
      let price = basePrice;
      const trend = (Math.random() - 0.3) * 0.5;
      
      for (let i = 0; i < days; i++) {
        const dailyChange = trend + (Math.random() - 0.5) * 3;
        price += dailyChange;
        
        const weeklyWave = Math.sin((i / 7) * Math.PI * 2) * 2;
        price += weeklyWave;
        
        const noise = (Math.random() - 0.5) * 1;
        price += noise;
        
        price = Math.max(basePrice * 0.7, Math.min(basePrice * 1.5, price));
        
        data.push(parseFloat(price.toFixed(2)));
      }
      
      return data;
    }

    // Функция для генерации дат
    function generateDateLabels(days) {
      const labels = [];
      const today = new Date();
      
      for (let i = 0; i < days; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() - (days - i - 1));
        labels.push(date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' }));
      }
      
      return labels;
    }

    // Функция для расчета статистики
    function calculateStats(data) {
      const max = Math.max(...data);
      const min = Math.min(...data);
      const change = ((data[data.length - 1] - data[0]) / data[0] * 100).toFixed(2);
      
      return { max: max.toFixed(2), min: min.toFixed(2), change };
    }

    // Переопределяем функцию loadForecast из chartplaceholder.js
    const originalLoadForecast = window.loadForecast;
    
    // Сохраняем ссылку на глобальный объект chart
    window.chartInstance = null;

    document.addEventListener("DOMContentLoaded", () => {
      const ctx = document.getElementById("chart");
      const infoText = document.getElementById("info-text");
      
      // Переопределяем loadForecast чтобы использовать сгенерированные данные
      window.loadForecast = async function() {
        try {
          const currentPeriod = parseInt(document.querySelector(".period-list li.active")?.dataset.period || 30);
          const priceData = generatePriceData(currentPeriod);
          const dateLabels = generateDateLabels(currentPeriod);
          const stats = calculateStats(priceData);
          const currentScenario = window.currentScenario || "positive";

          infoText.textContent = `Цена: ${priceData[priceData.length - 1]}₽, Макс: ${stats.max}₽, Мин: ${stats.min}₽, Изменение: ${stats.change}%`;

          if (window.chartInstance) window.chartInstance.destroy();

          window.chartInstance = new Chart(ctx, {
            type: "line",
            data: {
              labels: dateLabels,
              datasets: [{
                label: `Прогноз (${currentScenario})`,
                data: priceData,
                borderColor: currentScenario === "positive" ? "#22c55e" : "#ef4444",
                backgroundColor: currentScenario === "positive" ? "rgba(34, 197, 94, 0.05)" : "rgba(239, 68, 68, 0.05)",
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 2,
                pointBackgroundColor: currentScenario === "positive" ? "#22c55e" : "#ef4444",
                pointBorderColor: '#fff',
                pointBorderWidth: 1,
                pointHoverRadius: 5,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  padding: 12,
                  cornerRadius: 6,
                  callbacks: {
                    label: function(context) {
                      return `Цена: ${context.raw}₽`;
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                  }
                },
                x: {
                  grid: {
                    display: false
                  }
                }
              }
            }
          });

        } catch (error) {
          infoText.textContent = "Ошибка построения графика";
          console.error(error);
        }
      };

      // Добавляем обработчик для кликов на периоды
      document.querySelectorAll(".period-list li").forEach(li => {
        li.addEventListener('click', () => {
          document.querySelectorAll(".period-list li").forEach(el => el.classList.remove("active"));
          li.classList.add("active");
          
          // Показываем canvas и скрываем скелетон
          document.getElementById("chartSkeleton").style.display = "none";
          ctx.style.display = "block";
          
          window.loadForecast?.();
        });
      });
    });
  </script>

</body>
</html>
